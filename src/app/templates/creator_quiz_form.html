{% extends "base.html" %}
{% block title %}Quiz for {{ content.title }} – Language App{% endblock %}

{% block content %}
<div class="container--narrow">

  <a href="/creator/content/{{ content.id }}" class="back-link">← Back to content</a>

  <div class="page-header">
    <h1 class="page-title">{% if existing_quiz %}Edit{% else %}Add{% endif %} Quiz</h1>
    <p class="page-subtitle">
      <strong style="color:var(--text);">{{ content.title }}</strong> ·
      Add <strong style="color:var(--text);">3–5</strong> multiple-choice questions.
      Each needs a prompt, at least 2 options, and one correct answer.
    </p>
  </div>

  <div id="quiz-form">
    {% for slot in range(1, 6) %}
    <div class="fieldset-card" id="q{{ slot }}">
      <div class="fieldset-card__legend">
        <span style="width:28px;height:28px;background:rgba(0,212,138,0.10);border:1px solid rgba(0,212,138,0.20);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;color:var(--accent);">{{ slot }}</span>
        Question {{ slot }}
        {% if slot <= 3 %}
          <span class="chip chip-danger">required</span>
        {% else %}
          <span class="chip chip-muted">optional</span>
        {% endif %}
      </div>

      <div class="form-group">
        <label class="form-label" for="q{{ slot }}_prompt">Prompt</label>
        <textarea class="form-textarea" id="q{{ slot }}_prompt" rows="2"
                  placeholder="e.g. Which form is correct?"></textarea>
      </div>

      <div class="form-group" style="margin-bottom:8px;">
        <label class="form-label">Options <span style="font-weight:400;color:var(--text-subtle);">(mark the correct answer)</span></label>
      </div>

      {% for opt in range(1, 5) %}
      <div class="quiz-option">
        <input type="radio" name="q{{ slot }}_correct" value="{{ opt - 1 }}"
               id="q{{ slot }}_r{{ opt }}">
        <label for="q{{ slot }}_r{{ opt }}" class="quiz-option-label">{{ ["A","B","C","D"][opt-1] }}</label>
        <input type="text" id="q{{ slot }}_opt{{ opt }}" class="form-input"
               placeholder="Option {{ ["A","B","C","D"][opt-1] }}">
      </div>
      {% endfor %}

      <!-- Extra options (5th and 6th) — hidden by default -->
      {% for opt in range(5, 7) %}
      <div id="q{{ slot }}_extra{{ opt }}" class="quiz-option" style="display:none;">
        <input type="radio" name="q{{ slot }}_correct" value="{{ opt - 1 }}"
               id="q{{ slot }}_r{{ opt }}">
        <label for="q{{ slot }}_r{{ opt }}" class="quiz-option-label">{{ ["E","F"][opt-5] }}</label>
        <input type="text" id="q{{ slot }}_opt{{ opt }}" class="form-input"
               placeholder="Option {{ ["E","F"][opt-5] }}">
      </div>
      {% endfor %}

      <div class="actions" style="margin-top:10px;">
        <button type="button" class="add-opt-btn btn btn-ghost btn-sm" data-q="{{ slot }}">+ Add option</button>
        <button type="button" class="rm-opt-btn btn btn-ghost btn-sm" data-q="{{ slot }}" style="display:none;">− Remove last</button>
      </div>
    </div>
    {% endfor %}

    <div class="actions" style="margin-top:8px;">
      <button id="submit-btn" type="button" class="btn btn-primary">Save quiz →</button>
    </div>
    <div id="form-status" style="margin-top:14px;" aria-live="polite"></div>
  </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
  "use strict";

  /* ── Existing quiz data (null if new) ──────────────────────────────── */
  const EXISTING = {{ existing_quiz | tojson }};
  const CONTENT_ID = {{ content.id }};
  const NUM_SLOTS = 5;

  /* ── Pre-fill from existing quiz ───────────────────────────────────── */
  if (EXISTING && EXISTING.questions) {
    EXISTING.questions.forEach(function (q, i) {
      var slot = i + 1;
      if (slot > NUM_SLOTS) return;
      var promptEl = document.getElementById("q" + slot + "_prompt");
      if (promptEl) promptEl.value = q.prompt;

      q.options.forEach(function (opt, j) {
        var optEl = document.getElementById("q" + slot + "_opt" + (j + 1));
        if (optEl) {
          optEl.value = opt;
          if (j >= 4) {
            var container = document.getElementById("q" + slot + "_extra" + (j + 1));
            if (container) container.style.display = "flex";
          }
        }
      });

      var radioEl = document.getElementById("q" + slot + "_r" + (q.correct_option_index + 1));
      if (radioEl) radioEl.checked = true;
    });
  }

  /* ── Add / remove option buttons ───────────────────────────────────── */
  var optCounters = {};
  for (var s = 1; s <= NUM_SLOTS; s++) { optCounters[s] = 4; }

  document.querySelectorAll(".add-opt-btn").forEach(function (btn) {
    btn.addEventListener("click", function () {
      var q = parseInt(this.dataset.q, 10);
      if (optCounters[q] >= 6) return;
      optCounters[q]++;
      var el = document.getElementById("q" + q + "_extra" + optCounters[q]);
      if (el) el.style.display = "flex";
      document.querySelector(".rm-opt-btn[data-q='" + q + "']").style.display = "inline-flex";
      if (optCounters[q] >= 6) this.style.display = "none";
    });
  });

  document.querySelectorAll(".rm-opt-btn").forEach(function (btn) {
    btn.addEventListener("click", function () {
      var q = parseInt(this.dataset.q, 10);
      if (optCounters[q] <= 4) return;
      var el = document.getElementById("q" + q + "_extra" + optCounters[q]);
      if (el) {
        el.style.display = "none";
        var input = el.querySelector("input[type=text]");
        if (input) input.value = "";
        var radio = el.querySelector("input[type=radio]");
        if (radio) radio.checked = false;
      }
      optCounters[q]--;
      document.querySelector(".add-opt-btn[data-q='" + q + "']").style.display = "inline-flex";
      if (optCounters[q] <= 4) this.style.display = "none";
    });
  });

  /* ── Collect + validate + submit ────────────────────────────────────── */
  var statusEl = document.getElementById("form-status");
  var submitBtn = document.getElementById("submit-btn");

  function setStatus(msg, isError) {
    statusEl.textContent = msg;
    statusEl.className = isError ? "form-status-err" : "form-status-ok";
  }

  submitBtn.addEventListener("click", async function () {
    var questions = [];

    for (var slot = 1; slot <= NUM_SLOTS; slot++) {
      var prompt = (document.getElementById("q" + slot + "_prompt").value || "").trim();
      if (!prompt) continue;

      var options = [];
      for (var o = 1; o <= 6; o++) {
        var optEl = document.getElementById("q" + slot + "_opt" + o);
        if (!optEl) continue;
        var val = (optEl.value || "").trim();
        if (val) options.push(val);
      }

      var correctRadio = document.querySelector(
        "input[name='q" + slot + "_correct']:checked"
      );
      var correctIndex = correctRadio ? parseInt(correctRadio.value, 10) : -1;

      questions.push({ prompt: prompt, options: options, correct_option_index: correctIndex });
    }

    if (questions.length < 3 || questions.length > 5) {
      setStatus("Please fill in 3–5 questions.", true);
      return;
    }
    for (var i = 0; i < questions.length; i++) {
      if (questions[i].options.length < 2) {
        setStatus("Question " + (i + 1) + " needs at least 2 options.", true);
        return;
      }
      if (questions[i].correct_option_index < 0) {
        setStatus("Question " + (i + 1) + ": please mark the correct answer.", true);
        return;
      }
      if (questions[i].correct_option_index >= questions[i].options.length) {
        setStatus("Question " + (i + 1) + ": correct answer is out of range.", true);
        return;
      }
    }

    submitBtn.disabled = true;
    statusEl.className = "";
    statusEl.textContent = "Saving quiz…";

    try {
      var res = await fetch("/api/creator/content/" + CONTENT_ID + "/quiz", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ questions: questions }),
      });
      var body = await res.json().catch(function () { return {}; });
      if (res.ok) {
        setStatus(
          "Quiz saved (" + body.question_count + " question" +
          (body.question_count !== 1 ? "s" : "") + ")! Redirecting…",
          false
        );
        setTimeout(function () {
          window.location.href = "/creator/content/" + CONTENT_ID;
        }, 800);
      } else {
        setStatus("Error: " + (body.detail || res.statusText), true);
        submitBtn.disabled = false;
      }
    } catch (_) {
      setStatus("Network error. Please try again.", true);
      submitBtn.disabled = false;
    }
  });
}());
</script>
{% endblock %}
