{% extends "base.html" %}
{% block title %}Feed â€“ Language App{% endblock %}

{% block content %}
<div class="container">

  <!-- Page header -->
  <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
    <div>
      <h1 class="page-title">Your Feed</h1>
      <p class="page-subtitle">
        Learning <strong style="color:var(--text);">{{ profile.target_language.value | upper }}</strong>
        Â· Level <strong style="color:var(--text);">{{ profile.level.value }}</strong>
        &nbsp;<a href="/onboarding" style="font-size:0.8125rem;color:var(--accent);font-weight:500;">Change</a>
      </p>
    </div>
    <a href="/progress" class="btn btn-ghost btn-sm">View progress â†’</a>
  </div>

  <!-- Feed -->
  <div id="feed-container">
    {% for video in items %}
    <div class="video-card">
      <div class="video-card__media">
        <video controls preload="metadata">
          <source src="{{ video.video_url }}" type="video/mp4">
          Your browser does not support the video element.
        </video>
      </div>
      <div class="video-card__body">
        <h3 class="video-card__title">{{ video.title }}</h3>
        {% if video.caption %}
        <p class="video-card__caption">{{ video.caption }}</p>
        {% endif %}
        <div class="video-card__footer">
          <div class="video-card__meta">
            <span class="chip chip-muted">{{ video.language.value | upper }}</span>
            <span class="chip chip-muted">{{ video.level.value }}</span>
            {% if video.published_at %}
            <span class="meta-dot">Â·</span>
            <span>{{ video.published_at.strftime('%b %d, %Y') }}</span>
            {% endif %}
          </div>
          <a href="/content/{{ video.id }}/quiz" class="btn btn-primary btn-sm">
            Take quiz â†’
          </a>
        </div>
      </div>
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-state__icon">ðŸ“­</div>
      <div class="empty-state__title">No videos yet</div>
      <p id="empty-state" class="empty-state__desc">
        No videos available for your language and level yet. Check back soon!
      </p>
    </div>
    {% endfor %}
  </div>

  {% if next_cursor %}
  <div style="text-align:center;margin-top:12px;">
    <button id="load-more-btn" class="btn btn-ghost" data-cursor="{{ next_cursor }}">
      Load more
    </button>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
  "use strict";
  const btn = document.getElementById("load-more-btn");
  if (!btn) return;

  btn.addEventListener("click", async function () {
    btn.disabled = true;
    btn.textContent = "Loadingâ€¦";

    const cursor = btn.dataset.cursor;
    let data;
    try {
      const res = await fetch(
        "/api/feed?cursor=" + encodeURIComponent(cursor) + "&limit=10",
        { credentials: "same-origin" }
      );
      if (!res.ok) {
        alert("Failed to load more videos (status " + res.status + ").");
        btn.disabled = false;
        btn.textContent = "Load more";
        return;
      }
      data = await res.json();
    } catch (err) {
      alert("Network error. Please try again.");
      btn.disabled = false;
      btn.textContent = "Load more";
      return;
    }

    const container = document.getElementById("feed-container");

    // Remove empty-state message if present
    const empty = document.getElementById("empty-state");
    if (empty) empty.closest(".empty-state") ? empty.closest(".empty-state").remove() : empty.remove();

    for (const v of data.items) {
      const card = document.createElement("div");
      card.className = "video-card";

      const media = document.createElement("div");
      media.className = "video-card__media";

      const video = document.createElement("video");
      video.controls = true;
      video.preload = "metadata";
      const source = document.createElement("source");
      source.src = v.video_url;
      source.type = "video/mp4";
      video.appendChild(source);
      video.appendChild(document.createTextNode("Your browser does not support the video element."));
      media.appendChild(video);
      card.appendChild(media);

      const body = document.createElement("div");
      body.className = "video-card__body";

      const title = document.createElement("h3");
      title.className = "video-card__title";
      title.textContent = v.title;
      body.appendChild(title);

      if (v.caption) {
        const caption = document.createElement("p");
        caption.className = "video-card__caption";
        caption.textContent = v.caption;
        body.appendChild(caption);
      }

      const footer = document.createElement("div");
      footer.className = "video-card__footer";

      const meta = document.createElement("div");
      meta.className = "video-card__meta";
      const langChip = document.createElement("span");
      langChip.className = "chip chip-muted";
      langChip.textContent = v.language.toUpperCase();
      meta.appendChild(langChip);
      const lvlChip = document.createElement("span");
      lvlChip.className = "chip chip-muted";
      lvlChip.textContent = v.level;
      meta.appendChild(lvlChip);
      const pubDate = v.published_at ? v.published_at.slice(0, 10) : "";
      if (pubDate) {
        const dot = document.createElement("span");
        dot.className = "meta-dot";
        dot.textContent = "Â·";
        meta.appendChild(dot);
        const date = document.createElement("span");
        date.textContent = pubDate;
        meta.appendChild(date);
      }
      footer.appendChild(meta);

      const quizLink = document.createElement("a");
      quizLink.href = "/content/" + v.id + "/quiz";
      quizLink.textContent = "Take quiz â†’";
      quizLink.className = "btn btn-primary btn-sm";
      footer.appendChild(quizLink);

      body.appendChild(footer);
      card.appendChild(body);
      container.appendChild(card);
    }

    if (data.next_cursor) {
      btn.dataset.cursor = data.next_cursor;
      btn.disabled = false;
      btn.textContent = "Load more";
    } else {
      btn.parentElement.remove();
    }
  });
}());
</script>
{% endblock %}
