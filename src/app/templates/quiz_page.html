{% extends "base.html" %}
{% block title %}{{ content.title }} – Quiz – Language App{% endblock %}

{% block content %}
<div class="container--narrow">

  <a href="/feed" class="back-link">← Back to feed</a>

  <div class="page-header">
    <h1 class="page-title">{{ content.title }}</h1>
  </div>

  <!-- Video player -->
  <div class="card" style="margin-bottom:24px;overflow:hidden;">
    <div style="background:#000;">
      <video controls style="width:100%;max-height:360px;display:block;">
        <source src="{{ content.video_url }}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
  </div>

  <!-- Quiz -->
  <div class="section-title">Quiz</div>

  <div class="alert alert-error" id="quiz-error" style="display:none;" role="alert">
    <span class="alert-icon">⚠</span>
    <span id="quiz-error-text"></span>
  </div>

  <form id="quiz-form">
    {% for q in questions %}
    <div class="quiz-fieldset">
      <legend>{{ loop.index }}. {{ q.prompt }}</legend>
      {% for opt in q.options %}
      <label class="quiz-radio-label">
        <input type="radio" name="q_{{ q.id }}" value="{{ loop.index0 }}" required>
        {{ opt }}
      </label>
      {% endfor %}
    </div>
    {% endfor %}

    <div style="margin-top:8px;">
      <button type="submit" class="btn btn-primary">Submit answers →</button>
    </div>
  </form>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
  var CONTENT_ID = {{ content.id }};
  var QUESTION_IDS = {{ questions | map(attribute='id') | list | tojson }};

  document.getElementById('quiz-form').addEventListener('submit', function (e) {
    e.preventDefault();
    var errEl   = document.getElementById('quiz-error');
    var errText = document.getElementById('quiz-error-text');
    errEl.style.display = 'none';

    var answers = [];
    for (var i = 0; i < QUESTION_IDS.length; i++) {
      var qid = QUESTION_IDS[i];
      var radios = document.querySelectorAll('input[name="q_' + qid + '"]');
      var selected = null;
      for (var j = 0; j < radios.length; j++) {
        if (radios[j].checked) { selected = parseInt(radios[j].value, 10); break; }
      }
      if (selected === null) {
        errText.textContent = 'Please answer all questions before submitting.';
        errEl.style.display = 'flex';
        errEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }
      answers.push({ question_id: qid, selected_index: selected });
    }

    fetch('/api/content/' + CONTENT_ID + '/attempt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ answers: answers })
    })
    .then(function (r) { return r.json().then(function (d) { return { ok: r.ok, data: d }; }); })
    .then(function (res) {
      if (res.ok) {
        window.location.href = '/attempts/' + res.data.attempt_id;
      } else {
        errText.textContent = res.data.detail || 'Submission failed. Please try again.';
        errEl.style.display = 'flex';
      }
    })
    .catch(function () {
      errText.textContent = 'Network error. Please try again.';
      errEl.style.display = 'flex';
    });
  });
}());
</script>
{% endblock %}
